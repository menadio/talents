name: 'Dev Deployment'

on:
  push:
    branches: [ development ]

jobs:
  bookstars-stageing-api-tests:

    runs-on: self-hosted

    steps:
    - uses: shivammathur/setup-php@15c43e89cdef867065b0213be354c2841860869e
      with:
        php-version: '8.0'
    - uses: actions/checkout@v3

    - name: "Setup nova authentication"
      run: |
          composer config http-basic.nova.laravel.com ${{ secrets.NOVA_USERNAME }} ${{ secrets.NOVA_PASSWORD }}
    
    - name: "Install app dependencies"
      run: composer install --ignore-platform-reqs

    - name: "Setup env file"
      env:
        APP_KEY: ${{ secrets.DEV_APP_KEY }}
        DB_DATABASE: ${{ secrets.DEV_DB }}
        DB_USERNAME: ${{ secrets.DEV_DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DEV_DB_PASSWORD }}
      run: |
          php -r "file_exists('.env') || copy('.env.example', '.env');"
          echo APP_KEY: ${{ secrets.DEV_APP_KEY }} >> .env
          echo DB_DATABASE: ${{ secrets.DEV_DB }} >> .env
          echo DB_USERNAME: ${{ secrets.DEV_DB_USERNAME }} >> .env
          echo DB_PASSWORD: ${{ secrets.DEV_DB_PASSWORD }} >> .env

    - run: php artisan config:cache
    - run: php artisan route:cache